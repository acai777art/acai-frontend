<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Affective Realms: LUMINA ‚Äî Prologue Chat</title>
<style>
  :root{
    --bg:#07090f; --card:#0b0f18; --ink:#e9eef8; --muted:#9aa3af;
    --accent:#7AE6FF; --ring:#7AE6FF60; --violet:#B37AFF; --amber:#FFB76B;
    --bg-image:url("./bg_lumina.jpg");
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;color:var(--ink);font:16px/1.5 ui-sans-serif,system-ui,-apple-system,"SF Pro Text",Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;background:#000;overflow:hidden;}
  .bg{position:fixed;inset:0;z-index:-3;background-image:var(--bg-image);background-size:cover;background-position:center;background-repeat:no-repeat;filter:saturate(1.05) brightness(.95);}
  .bg::after{content:"";position:absolute;inset:0;background:
      radial-gradient(1300px 800px at 80% -10%, color-mix(in oklab, var(--accent) 16%, #000) 0%, transparent 62%),
      radial-gradient(1000px 600px at -10% 90%, color-mix(in oklab, var(--accent) 10%, #000) 0%, transparent 56%),
      linear-gradient(180deg,#07090fbb 0%, #06080dcc 100%);}
  .grid{position:fixed;inset:0;pointer-events:none;opacity:.07;z-index:-2;background-image:
      radial-gradient(1px 1px at 10% 20%, #fff 50%, transparent 51%),
      radial-gradient(1px 1px at 70% 60%, #fff 50%, transparent 51%),
      radial-gradient(1px 1px at 30% 80%, #fff 50%, transparent 51%);
    background-size:26px 26px,32px 32px,42px 42px;mix-blend-mode:screen;}
  .bar{height:68px;padding:0 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid color-mix(in oklab, var(--accent) 18%, transparent);
    background:linear-gradient(180deg, color-mix(in oklab, var(--accent) 9%, #000) 0%, transparent 100%);position:sticky;top:0;z-index:5;backdrop-filter:blur(6px);}
  .spark{width:28px;height:28px;border-radius:10px;background:conic-gradient(from 210deg, var(--accent), var(--violet), var(--amber), var(--accent));
    box-shadow:0 0 0 2px #0a0d14,0 0 22px var(--ring) inset,0 8px 22px #0008;animation:orbit 8s linear infinite;}
  @keyframes orbit{from{filter:hue-rotate(0)}to{filter:hue-rotate(360deg)}}
  .title{font-weight:900;letter-spacing:.18em;text-transform:uppercase;background:linear-gradient(90deg,var(--accent),var(--violet),var(--amber));
    -webkit-background-clip:text;background-clip:text;color:transparent;background-size:200% 100%;animation:titleFlow 9s linear infinite;text-shadow:0 0 18px #7ae6ff22;}
  @keyframes titleFlow{from{background-position:0% 50%}to{background-position:200% 50%}}
  .tone{margin-left:auto;padding:7px 12px;border-radius:999px;background:color-mix(in oklab, var(--accent) 18%, #000);
    color:color-mix(in oklab, var(--ink) 80%, var(--accent));border:1px solid color-mix(in oklab, var(--accent) 40%, transparent);
    font-size:12px;text-transform:uppercase;letter-spacing:.16em;opacity:.9;}

  .wrap{
    height:calc(100% - 68px);
    display:grid;
    grid-template-rows:1fr auto;
    grid-template-columns: 1fr;
    grid-template-areas:
      "feed"
      "composer";
  }

  .feed{grid-area:feed; overflow:auto;padding:24px 16px 8px 16px;scroll-behavior:smooth; -webkit-overflow-scrolling:touch;}
  .bubble{max-width:min(860px,92vw);margin:10px 0;padding:14px 16px;white-space:pre-wrap;border-radius:14px;position:relative;
    background:linear-gradient(180deg,#0b0f18 0%,#0a0e15 100%);border:1px solid color-mix(in oklab, var(--accent) 18%, #1a2230);
    box-shadow:0 1px 0 #0008,inset 0 0 0 999px #ffffff03,0 8px 24px #000a;}
  .bubble::after{content:"";position:absolute;inset:-1px;border-radius:inherit;pointer-events:none;background:
    linear-gradient(120deg,transparent 30%,rgba(255,255,255,.12) 50%,transparent 70%);mix-blend-mode:screen;opacity:0;transition:opacity .25s;}
  .bubble:hover::after{opacity:.65}
  .acai{border-color:color-mix(in oklab, var(--accent) 25%, #1a2230)}
  .me{margin-left:auto;background:linear-gradient(180deg,color-mix(in oklab, var(--accent) 26%, #0b0f18),#0a0e15);
    border-color:color-mix(in oklab, var(--accent) 34%, #1a2230);}
  .typing{display:inline-flex;align-items:center;gap:8px;color:color-mix(in oklab, var(--ink) 75%, var(--accent));font-weight:600;letter-spacing:.06em;}
  .dots{display:inline-flex;gap:4px;}
  .dots i{width:6px;height:6px;border-radius:50%;background:color-mix(in oklab, var(--accent) 90%, #fff);opacity:.4;animation:blink 1.2s infinite;}
  .dots i:nth-child(2){animation-delay:.2s}.dots i:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,100%{opacity:.2;transform:translateY(0)}50%{opacity:1;transform:translateY(-2px)}}

  .composer{
    grid-area: composer;
    padding:12px 16px 18px;display:flex;gap:10px;border-top:1px solid #0a0d12;background:linear-gradient(180deg,#0a0f16,#080b11);
  }
  .in{flex:1;background:#0e131b;border:1px solid #151c26;color:var(--ink);border-radius:12px;padding:12px 14px;outline:none;
    transition:border-color .2s,box-shadow .2s;resize:none;min-height:46px;max-height:180px;line-height:1.4;}
  .in:focus{border-color:color-mix(in oklab, var(--accent) 38%, #222);box-shadow:0 0 0 3px color-mix(in oklab, var(--accent) 22%, transparent);}
  .btn{--mx:50%;--my:50%;position:relative;display:inline-flex;align-items:center;justify-content:center;padding:0 18px;min-width:118px;border-radius:12px;border:none;cursor:pointer;
    background:linear-gradient(135deg,var(--accent),var(--amber));box-shadow:0 12px 26px rgba(122,230,255,.35),0 2px 8px rgba(0,0,0,.45);
    color:#051014;font-weight:900;letter-spacing:.14em;text-transform:uppercase;overflow:hidden;transform-style:preserve-3d;transition:transform .18s,box-shadow .18s,filter .18s;}
  .btn .label{position:relative;z-index:2;background:linear-gradient(90deg,#fff,#d8f7ff,#fff);background-size:200% 100%;
    -webkit-background-clip:text;background-clip:text;color:transparent;animation:shineText 3.2s linear infinite;}
  @keyframes shineText{from{background-position:0% 50%}to{background-position:200% 50%}}
  .btn::after{content:"";position:absolute;inset:-1px;pointer-events:none;background:radial-gradient(140px 140px at var(--mx) var(--my),rgba(255,255,255,.2),rgba(255,255,255,0) 60%);opacity:0;transition:opacity .18s;}
  .btn::before{content:"";position:absolute;left:-40%;top:-220%;width:180%;height:420%;transform:rotate(22deg);background:linear-gradient(to right,transparent 46%,rgba(255,255,255,.16) 50%,transparent 54%);
    mix-blend-mode:screen;opacity:0;transition:opacity .25s;}
  .btn:hover{box-shadow:0 18px 42px rgba(122,230,255,.45),0 6px 18px rgba(0,0,0,.55)}
  .btn:hover::after{opacity:1}.btn:hover::before{opacity:1;animation:sweep 1.4s ease}
  @keyframes sweep{from{left:-40%}to{left:60%}}.btn:active{transform:perspective(700px) translateZ(0) scale(.985)}
  .btn.ghost{background:linear-gradient(180deg,#0e131b,#0a0e14);color:var(--ink);border:1px solid color-mix(in oklab,var(--accent)28%,#1a2230);box-shadow:0 2px 10px rgba(0,0,0,.45),inset 0 0 0 999px #ffffff08;transition:filter .2s ease,box-shadow .2s ease;}
  .btn.ghost .label{background:none;color:var(--ink);-webkit-background-clip:initial;background-clip:initial;animation:none;opacity:.9;}
  .btn.ghost:hover{filter:brightness(1.08);box-shadow:0 4px 18px rgba(122,230,255,.2);}
  .btn.sm{min-width:92px;padding:8px 12px;height:36px;font-size:12px;letter-spacing:.12em;}

  /* ===== LUX PANEL styles (kept) ===== */
  .panel{
    position:relative;
    padding:14px 14px 12px;
    border-radius: 18px;
    background: linear-gradient(180deg,#0b0f18 0%,#0a0e15 100%);
    border: 1px solid color-mix(in oklab, var(--accent) 18%, #1a2230);
    box-shadow: 0 1px 0 #0008, inset 0 0 0 999px #ffffff03, 0 14px 36px #000b;
    overflow:hidden;
  }
  .panel::before{
    content:"";
    position:absolute; inset:-2px;
    border-radius: inherit;
    background: radial-gradient(420px 260px at 30% 20%, color-mix(in oklab, var(--accent) 26%, transparent) 0%, transparent 60%),
                radial-gradient(320px 240px at 80% 30%, color-mix(in oklab, var(--violet) 18%, transparent) 0%, transparent 62%);
    filter: blur(10px);
    opacity:.9;
    pointer-events:none;
  }
  .panel::after{
    content:"";
    position:absolute; inset:-40% -40%;
    background: linear-gradient(120deg, transparent 40%, rgba(255,255,255,.10) 50%, transparent 60%);
    transform: rotate(10deg);
    opacity:.0;
    pointer-events:none;
  }
  .panel:hover::after{ opacity:.55; animation: shimmer 1.3s ease; }
  @keyframes shimmer { from{ transform: translateX(-18%) rotate(10deg);} to{ transform: translateX(18%) rotate(10deg);} }

  .panelHead{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:space-between;
    margin-bottom:10px;
    gap:10px;
  }
  .panelTitle{
    font-weight: 900;
    letter-spacing: .14em;
    text-transform: uppercase;
    font-size: 12px;
    color: color-mix(in oklab, var(--ink) 82%, var(--accent));
    opacity:.95;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .pill{
    position:relative;
    font-size: 11px;
    padding:6px 10px;
    border-radius: 999px;
    border: 1px solid color-mix(in oklab, var(--accent) 30%, transparent);
    background: color-mix(in oklab, var(--accent) 12%, #000);
    color: color-mix(in oklab, var(--ink) 78%, var(--accent));
    opacity:.95;
    white-space:nowrap;
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }
  .luxDot{
    width:10px;height:10px;border-radius:50%;
    background: var(--accent);
    box-shadow: 0 0 18px var(--ring), 0 0 40px color-mix(in oklab, var(--accent) 25%, transparent);
    animation: breathe 2.4s ease-in-out infinite;
  }
  @keyframes breathe{
    0%,100%{ transform: scale(.92); filter:saturate(1.0); opacity:.75; }
    50%{ transform: scale(1.14); filter:saturate(1.2); opacity:1; }
  }
  .miniLegend{
    position:relative;
    display:flex; flex-wrap:wrap; gap:6px;
    margin-top:10px;
  }
  .tag{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--accent) 22%, #1a2230);
    background: linear-gradient(180deg, #0e131b, #0a0e14);
    color: color-mix(in oklab, var(--ink) 76%, var(--accent));
    opacity:.92;
  }

  /* ===== EDGE WIDGETS ===== */
  .edgeBtns{
    position:fixed;
    right:10px;
    top: calc(68px + 14px);
    z-index: 20;
    display:flex;
    flex-direction:column;
    gap:10px;
    pointer-events:auto;
  }
  .edgeBtn{
    width:44px;height:44px;
    border-radius:14px;
    border:1px solid color-mix(in oklab, var(--accent) 28%, #1a2230);
    background: linear-gradient(180deg,#0e131b,#0a0e14);
    box-shadow: 0 10px 26px rgba(0,0,0,.55), inset 0 0 0 999px #ffffff07;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    color: color-mix(in oklab, var(--ink) 78%, var(--accent));
    transition: transform .16s ease, filter .16s ease, box-shadow .16s ease;
    user-select:none;
  }
  .edgeBtn:hover{ filter:brightness(1.08); box-shadow: 0 14px 34px rgba(0,0,0,.62), 0 0 22px var(--ring); }
  .edgeBtn:active{ transform:scale(.98); }
  .edgeBtn svg{ width:22px;height:22px; opacity:.92; }

  .overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.45);
    backdrop-filter: blur(6px);
    z-index: 30;
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease;
  }
  .overlay.show{ opacity:1; pointer-events:auto; }

  /* ‚úÖ FIX: drawer has strict height + flex column */
  .drawer{
    position:fixed;
    top:68px;
    right:0;
    height: calc(100% - 68px);
    width: min(420px, 92vw);
    z-index: 40;
    transform: translateX(104%);
    transition: transform .22s cubic-bezier(.2,.9,.2,1);
    padding: 14px 12px 14px 12px;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden; /* ‚úÖ prevents ‚Äúinfinite‚Äù */
  }
  .drawer.open{ transform: translateX(0); }

  .drawerHeader{
    flex: 0 0 auto;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding: 10px 10px;
    border-radius: 16px;
    background: linear-gradient(180deg,#0b0f18 0%,#0a0e15 100%);
    border: 1px solid color-mix(in oklab, var(--accent) 18%, #1a2230);
    box-shadow: 0 10px 30px #000a, inset 0 0 0 999px #ffffff03;
  }
  .drawerTitle{
    display:flex;align-items:center;gap:10px;
    font-weight:900;
    letter-spacing:.14em;
    text-transform:uppercase;
    font-size:12px;
    color: color-mix(in oklab, var(--ink) 82%, var(--accent));
  }
  .drawerClose{
    border:none;
    background: linear-gradient(180deg,#0e131b,#0a0e14);
    color: var(--ink);
    border:1px solid color-mix(in oklab, var(--accent) 22%, #1a2230);
    border-radius: 12px;
    height:34px;
    padding:0 12px;
    cursor:pointer;
    box-shadow: 0 10px 22px rgba(0,0,0,.42), inset 0 0 0 999px #ffffff06;
  }

  /* ‚úÖ FIX: body takes remaining height */
  .drawerBody{
    flex: 1 1 auto;
    min-height: 0;                 /* ‚úÖ crucial for iOS flex scroll */
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    padding-right: 2px;
  }

  /* ‚úÖ FIX: chart boxes have strict height, canvas fills them */
  .chartBox{
    height: min(46vh, 420px);
    width: 100%;
    position: relative;
  }
  .chartBox.radarBox{ height: min(44vh, 380px); }
  .chartBox.emcBox{ height: min(46vh, 420px); }

  canvas{ display:block; width:100% !important; height:100% !important; }

  @media (max-width: 520px){
    .edgeBtns{ top: calc(68px + 10px); right: 8px; }
    .drawer{ width: 94vw; }
    .chartBox{ height: min(52vh, 420px); }
    .chartBox.radarBox{ height: min(48vh, 380px); }
  }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="grid" aria-hidden="true"></div>

  <header class="bar">
    <div class="spark" aria-hidden="true"></div>
    <div class="title">AFFECTIVE CONTEXTUAL AI</div>
    <div class="tone" id="tone">NEUTRAL</div>
    <button class="btn ghost sm" id="logout" type="button">
      <span class="label">LOGOUT</span>
    </button>
  </header>

  <section class="wrap">
    <div class="feed" id="feed"></div>

    <form class="composer" id="form" novalidate>
      <textarea id="msg" class="in" placeholder="Type a message‚Ä¶" rows="1"></textarea>
      <button class="btn" id="send" type="submit"><span class="label">SEND</span></button>
      <button class="btn ghost" id="clean" type="button"><span class="label">CLEAN</span></button>
    </form>
  </section>

  <!-- Edge Buttons -->
  <div class="edgeBtns" aria-label="Widgets">
    <button class="edgeBtn" id="openRadar" type="button" title="Emotion Radar">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 21a9 9 0 1 0-9-9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 12l6-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M3 12h2M12 3v2M19 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".8"/>
        <circle cx="12" cy="12" r="2" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>

    <button class="edgeBtn" id="openEMC" type="button" title="E ¬∑ M ¬∑ C Timeline">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M4 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M4 19H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 15l4-5 4 3 5-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="10" cy="10" r="1.5" fill="currentColor"/>
        <circle cx="14" cy="13" r="1.5" fill="currentColor" opacity=".9"/>
        <circle cx="19" cy="6" r="1.5" fill="currentColor" opacity=".85"/>
      </svg>
    </button>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true"></div>

  <!-- Drawer: RADAR -->
  <aside class="drawer" id="radarDrawer" aria-label="Emotion Radar Widget">
    <div class="drawerHeader">
      <div class="drawerTitle"><span class="luxDot" aria-hidden="true"></span> Emotion Radar</div>
      <button class="drawerClose" type="button" data-close="radar">Close</button>
    </div>
    <div class="drawerBody">
      <section class="panel">
        <div class="panelHead">
          <div class="panelTitle"><span class="luxDot" aria-hidden="true"></span> Emotion Radar</div>
          <div class="pill" id="radarMeta">‚Äî</div>
        </div>
        <div class="chartBox radarBox">
          <canvas id="emotionRadar"></canvas>
        </div>
        <div class="miniLegend" id="emotionTags"></div>
      </section>
    </div>
  </aside>

  <!-- Drawer: EMC -->
  <aside class="drawer" id="emcDrawer" aria-label="E M C Widget">
    <div class="drawerHeader">
      <div class="drawerTitle"><span class="luxDot" aria-hidden="true"></span> E ¬∑ M ¬∑ C Timeline</div>
      <button class="drawerClose" type="button" data-close="emc">Close</button>
    </div>
    <div class="drawerBody">
      <section class="panel">
        <div class="panelHead">
          <div class="panelTitle"><span class="luxDot" aria-hidden="true"></span> E ¬∑ M ¬∑ C Timeline</div>
          <div class="pill" id="emcMeta">‚Äî</div>
        </div>
        <div class="chartBox emcBox">
          <canvas id="emcChart"></canvas>
        </div>
      </section>
    </div>
  </aside>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(function bootToken(){
  const qs = new URLSearchParams(location.search);
  const t = qs.get('token');
  if (t && t.length > 10) {
    try { localStorage.setItem('acai_jwt', t); } catch {}
    history.replaceState({}, '', location.pathname + location.hash);
  }
})();

const API = (localStorage.getItem('ACAI_API') || 'https://acai-backend.onrender.com').replace(/\/$/,'');

function authHeaders(){
  let tok = null;
  try { tok = localStorage.getItem('acai_jwt'); } catch {}
  return tok ? { Authorization: 'Bearer ' + tok } : {};
}

async function apiPost(path, data){
  const r = await fetch(API+path, {
    method:'POST',
    credentials:'include',
    headers:{'Content-Type':'application/json', ...authHeaders()},
    body: JSON.stringify(data||{})
  });
  if (r.status === 401) throw new Error('AUTH');
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}
async function apiDelete(path){
  const r = await fetch(API+path, {method:'DELETE', credentials:'include', headers: authHeaders()});
  if (r.status === 401) throw new Error('AUTH');
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

function forceReauth() { location.href = API + '/auth/refresh'; }

/* DOM */
const feed = document.getElementById('feed');
const tone = document.getElementById('tone');
const form = document.getElementById('form');
const msg  = document.getElementById('msg');
const cleanBtn = document.getElementById('clean');

/* Drawers */
const overlay = document.getElementById('overlay');
const radarDrawer = document.getElementById('radarDrawer');
const emcDrawer = document.getElementById('emcDrawer');
const openRadarBtn = document.getElementById('openRadar');
const openEMCBtn = document.getElementById('openEMC');

function closeAllDrawers(){
  radarDrawer.classList.remove('open');
  emcDrawer.classList.remove('open');
  overlay.classList.remove('show');
}
function afterOpenResize(which){
  // wait for drawer transition so canvas gets real size
  setTimeout(() => {
    if (which === 'radar' && radarChart){
      radarChart.resize();
      radarChart.update('none');
    }
    if (which === 'emc' && emcChart){
      emcChart.resize();
      emcChart.update('none');
    }
  }, 260);
}
function openDrawer(which){
  closeAllDrawers();
  if (which === 'radar') radarDrawer.classList.add('open');
  if (which === 'emc') emcDrawer.classList.add('open');
  overlay.classList.add('show');

  if (which === 'radar'){ ensureRadar(); applyLuxChartColors(); }
  if (which === 'emc'){ ensureEMC(); applyLuxChartColors(); }
  afterOpenResize(which);
}
openRadarBtn.addEventListener('click', ()=> openDrawer('radar'));
openEMCBtn.addEventListener('click', ()=> openDrawer('emc'));

overlay.addEventListener('click', closeAllDrawers);
document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeAllDrawers(); });
document.querySelectorAll('[data-close]').forEach(btn=>{
  btn.addEventListener('click', closeAllDrawers);
});

/* LUX DOM */
const radarMeta = document.getElementById('radarMeta');
const emcMeta = document.getElementById('emcMeta');
const tagsBox = document.getElementById('emotionTags');

let radarChart = null;
let emcChart = null;

function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function alphaColor(rgbLike, a){ return `color-mix(in oklab, ${rgbLike} ${Math.round(a*100)}%, transparent)`; }

/* Charts */
function ensureRadar(){
  if (radarChart) return;
  const radarCtx = document.getElementById('emotionRadar')?.getContext('2d');
  if (!radarCtx) return;

  radarChart = new Chart(radarCtx, {
    type: "radar",
    data: {
      labels: ["‚Äî","‚Äî","‚Äî","‚Äî","‚Äî"],
      datasets: [{
        label: "Top emotions",
        data: [0,0,0,0,0],
        fill: true,
        borderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 420 },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: "rgba(8,10,14,.92)",
          borderColor: "rgba(255,255,255,.10)",
          borderWidth: 1,
          titleColor: "#fff",
          bodyColor: "#fff",
          callbacks: {
            label: (ctx) => `${ctx.label}: ${(Number(ctx.raw||0)*100).toFixed(0)}%`
          }
        }
      },
      scales: {
        r: {
          min: 0, max: 1,
          grid: { color: "rgba(255,255,255,.06)" },
          angleLines: { color: "rgba(255,255,255,.08)" },
          pointLabels: { color: "rgba(255,255,255,.78)", font: { size: 12, weight: "600" } },
          ticks: { display: false }
        }
      }
    }
  });
}

const MAX_POINTS = 120;
const POLL_MS = 1500;
let t0 = performance.now();
let emcSeries = { t:[], E:[], M:[], C:[] };

function ensureEMC(){
  if (emcChart) return;
  const emcCtx = document.getElementById('emcChart')?.getContext('2d');
  if (!emcCtx) return;

  emcChart = new Chart(emcCtx, {
    type: "line",
    data: {
      labels: [],
      datasets: [
        { label:"E", data: [], borderWidth: 2, pointRadius: 0, tension: 0.28 },
        { label:"M", data: [], borderWidth: 2, pointRadius: 0, tension: 0.28 },
        { label:"C", data: [], borderWidth: 2, pointRadius: 0, tension: 0.28 },
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: { duration: 250 },
      plugins: {
        legend: { labels: { color: "rgba(255,255,255,.78)", boxWidth: 10, usePointStyle: true, pointStyle:"circle" } },
        tooltip: {
          backgroundColor: "rgba(8,10,14,.92)",
          borderColor: "rgba(255,255,255,.10)",
          borderWidth: 1,
          titleColor: "#fff",
          bodyColor: "#fff",
        }
      },
      scales: {
        x: { grid: { color: "rgba(255,255,255,.05)" }, ticks: { color: "rgba(255,255,255,.55)", maxTicksLimit: 6 } },
        y: { grid: { color: "rgba(255,255,255,.05)" }, ticks: { color: "rgba(255,255,255,.55)" }, suggestedMin: -1.2, suggestedMax:  1.2 }
      }
    }
  });
}

function applyLuxChartColors(){
  const accent = cssVar('--accent') || '#7AE6FF';
  if (radarChart){
    radarChart.data.datasets[0].borderColor = accent;
    radarChart.data.datasets[0].backgroundColor = alphaColor(accent, 0.14);
    radarChart.data.datasets[0].pointBackgroundColor = accent;
    radarChart.data.datasets[0].pointBorderColor = alphaColor(accent, 0.35);
    radarChart.update('none');
  }
  if (emcChart){
    const violet = cssVar('--violet') || '#B37AFF';
    const amber  = cssVar('--amber')  || '#FFB76B';
    emcChart.data.datasets[0].borderColor = accent;
    emcChart.data.datasets[1].borderColor = violet;
    emcChart.data.datasets[2].borderColor = amber;
    emcChart.update('none');
  }
}

function renderEmotionTags(top5){
  if (!tagsBox) return;
  tagsBox.innerHTML = "";
  (top5||[]).slice(0,5).forEach(([name, prob])=>{
    const el = document.createElement('span');
    el.className = 'tag';
    const p = clamp(Number(prob||0),0,1);
    el.textContent = `${name} ${(p*100).toFixed(0)}%`;
    tagsBox.appendChild(el);
  });
}

function updateRadarFromState(s){
  ensureRadar();
  if (!radarChart) return;

  const top5 = Array.isArray(s?.top5) ? s.top5 : [];
  const labels = top5.map(x => x?.[0] ?? "‚Äî");
  const values = top5.map(x => clamp(Number(x?.[1] ?? 0), 0, 1));
  while (labels.length < 5) labels.push("‚Äî");
  while (values.length < 5) values.push(0);

  radarChart.data.labels = labels.slice(0,5);
  radarChart.data.datasets[0].data = values.slice(0,5);

  renderEmotionTags(top5);

  const v = Number(s?.valence ?? 0);
  const x = Number(s?.impulse_x_ema ?? 0);
  if (radarMeta) radarMeta.textContent = `val=${v.toFixed(2)} ¬∑ x=${x.toFixed(2)}`;

  applyLuxChartColors();
  radarChart.update();
}

function pushEMCPoint(s){
  ensureEMC();
  if (!emcChart) return;

  const now = performance.now();
  const t = (now - t0) / 1000.0;
  const label = t < 60 ? `${t.toFixed(0)}s` : `${(t/60).toFixed(1)}m`;

  const E = Number(s?.E ?? 0);
  const M = Number(s?.M ?? 0);
  const C = Number(s?.C ?? 0);

  emcSeries.t.push(label);
  emcSeries.E.push(E);
  emcSeries.M.push(M);
  emcSeries.C.push(C);

  if (emcSeries.t.length > MAX_POINTS){
    emcSeries.t.shift(); emcSeries.E.shift(); emcSeries.M.shift(); emcSeries.C.shift();
  }

  emcChart.data.labels = emcSeries.t;
  emcChart.data.datasets[0].data = emcSeries.E;
  emcChart.data.datasets[1].data = emcSeries.M;
  emcChart.data.datasets[2].data = emcSeries.C;

  if (emcMeta) emcMeta.textContent = `E=${E.toFixed(2)} ¬∑ M=${M.toFixed(2)} ¬∑ C=${C.toFixed(2)}`;

  applyLuxChartColors();
  emcChart.update();
}

/* Chat local mirror */
let messages = JSON.parse(localStorage.getItem('lumina_chat') || '[]');
if (messages.length === 0) messages.push({role:'assistant', text:'ACAI: Greetings, conscious being. Synchronizing with your emotional field‚Ä¶'});
renderFeed();

msg.value = localStorage.getItem('lumina_draft') || '';
msg.addEventListener('input', ()=> localStorage.setItem('lumina_draft', msg.value));

function saveAndRender(){ localStorage.setItem('lumina_chat', JSON.stringify(messages)); renderFeed(); }
function renderFeed(){
  feed.innerHTML = '';
  for (const m of messages){
    const el = document.createElement('div');
    el.className = 'bubble ' + (m.role === 'user' ? 'me' : 'acai');
    el.textContent = (m.role === 'user' ? 'You: ' : '') + m.text;
    feed.appendChild(el);
  }
  feed.scrollTop = feed.scrollHeight;
}
function showTyping(){
  const el = document.createElement('div');
  el.className = 'bubble acai';
  el.innerHTML = `<span class="typing">ACAI is typing <span class="dots"><i></i><i></i><i></i></span></span>`;
  el.dataset.typing='1';
  feed.appendChild(el);
  feed.scrollTop = feed.scrollHeight;
  return el;
}
function hideTyping(el){ if(el && el.dataset.typing==='1') el.remove(); }

/* Theme from state */
const map=(v,inMin,inMax,outMin,outMax)=> outMin + (Math.max(inMin,Math.min(inMax,v))-inMin)*(outMax-outMin)/(inMax-inMin);
function themeFromState(s){
  const v = Number(s?.valence ?? 0);
  const x = Number(s?.impulse_x_ema ?? 0);
  const hue = (v >= 0) ? map(v, 0, 1, 210, 150) : map(v, -1, 0, 10, 210);
  const sat = map(Math.abs(x), 0, 0.5, 55, 92);
  const lig = 54;
  const accent = `oklch(${lig}% ${sat/100} ${hue})`;
  let mode='NEUTRAL';
  if(v>0.28) mode='GROUND'; else if(v<-0.22) mode='STABILIZE'; else if(v<-0.08) mode='UPLIFT';
  document.documentElement.style.setProperty('--accent', accent);
  document.documentElement.style.setProperty('--ring','color-mix(in oklab, var(--accent) 60%, transparent)');
  tone.textContent=mode;
  applyLuxChartColors();
}

/* State poll */
let currentCid = null;

async function refreshState(){
  try{
    if (!currentCid) return;
    const r = await fetch(API + `/state/${currentCid}`, {
      cache:'no-store',
      credentials:'include',
      headers: authHeaders()
    });
    if(!r.ok) return;
    const j=await r.json();
    const st = j?.last || {};
    themeFromState(st);
    updateRadarFromState(st);
    pushEMCPoint(st);
  }catch{}
}

async function ensureConversation(){
  if (currentCid) return currentCid;
  try{
    const res = await apiPost('/api/conversations', {});
    currentCid = res.id;
    return currentCid;
  } catch (e) {
    if (e.message === 'AUTH') {
      const loginUrl = API + '/login?from=' + encodeURIComponent(location.href);
      let w = null;
      try { w = window.open(loginUrl, '_blank', 'noopener'); } catch(_) {}
      setTimeout(() => { if (!w || w.closed) location.href = loginUrl; }, 300);
      alert('Please login via Telegram, then return here.');
    } else {
      console.error(e);
      alert('Cannot create conversation.');
    }
    throw e;
  }
}

/* Send */
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const text = msg.value.trim();
  if(!text) return;

  messages.push({role:'user', text});
  saveAndRender();

  const typingEl = showTyping();

  try{
    const cid = await ensureConversation();
    const j = await apiPost(`/api/chat/${cid}`, { message: text });
    hideTyping(typingEl);

    messages.push({role:'assistant', text: j?.reply || '(no reply)'});
    saveAndRender();

    msg.value = '';
    localStorage.removeItem('lumina_draft');
    msg.style.height = '46px';

    refreshState();

  }catch(err){
    hideTyping(typingEl);
    if (err.message === 'AUTH') {
      messages.push({role:'assistant', text:'Reauth‚Ä¶'});
      saveAndRender();
      forceReauth();
    } else {
      messages.push({role:'assistant', text:'Error: cannot reach backend.'});
      saveAndRender();
    }
  }
});

msg.addEventListener('input', ()=>{
  msg.style.height = 'auto';
  msg.style.height = Math.min(msg.scrollHeight, 180) + 'px';
});

/* CLEAN */
cleanBtn.addEventListener('click', async () => {
  if (!confirm("Delete local chat history? (You stay logged in)")) return;
  try { await apiDelete('/api/memory'); } catch(e){
    if (e.message==='AUTH'){ return forceReauth(); }
  }
  try {
    localStorage.removeItem('lumina_chat');
    localStorage.removeItem('lumina_draft');
    sessionStorage.clear?.();
  } catch {}
  messages = [{ role:'assistant', text:'ACAI: Greetings, conscious being. Synchronizing with your emotional field‚Ä¶' }];
  currentCid = null;

  emcSeries = { t:[], E:[], M:[], C:[] };
  t0 = performance.now();

  if (emcChart){
    emcChart.data.labels = [];
    emcChart.data.datasets.forEach(d => d.data = []);
    emcChart.update();
  }
  if (radarChart){
    radarChart.data.labels = ["‚Äî","‚Äî","‚Äî","‚Äî","‚Äî"];
    radarChart.data.datasets[0].data = [0,0,0,0,0];
    radarChart.update();
  }
  if (tagsBox) tagsBox.innerHTML = "";
  if (radarMeta) radarMeta.textContent = "‚Äî";
  if (emcMeta) emcMeta.textContent = "‚Äî";

  saveAndRender();
});

(async () => {
  try { await ensureConversation(); } catch(_) {}
  // charts can be lazy, but state may update them anytime
  ensureRadar(); ensureEMC(); applyLuxChartColors();
  refreshState();
  setInterval(refreshState, POLL_MS);
})();
</script>

<!-- üéµ LUMINA THEME MUSIC -->
<audio id="luminaMusic" loop>
  <source src="./lumina_theme.mp3" type="audio/mpeg">
</audio>
<script>
const audio = document.getElementById('luminaMusic');
document.addEventListener('click', () => {
  try {
    audio.volume = 0;
    audio.play().catch(()=>{});
    let v = 0;
    const fade = setInterval(() => {
      if (v < 0.35) { v += 0.01; audio.volume = v; } else { clearInterval(fade); }
    }, 120);
  } catch(e) { console.warn('Audio error', e); }
}, { once:true });
</script>

<!-- üíé Logout logic -->
<script>
document.getElementById('logout')?.addEventListener('click', async (e)=>{
  e.preventDefault();
  e.stopPropagation();

  if (!confirm('–í—ã –¥–µ–∏—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–∏—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) return;

  try { await fetch(API + '/logout', { method:'POST', credentials:'include', headers: authHeaders() }); } catch(e){}

  try {
    localStorage.removeItem('acai_jwt');
    localStorage.removeItem('lumina_chat');
    localStorage.removeItem('lumina_draft');
    sessionStorage.clear?.();
  } catch(e){}

  try {
    const u = new URL(location.href);
    u.searchParams.delete('token');
    history.replaceState({}, '', u.pathname + u.hash);
  } catch(e){}

  location.href = 'https://acai-frontend.onrender.com';
});
</script>

</body>
</html>
