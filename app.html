<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark" />
<title>ACAI ‚Äî LUMINA Console</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg0:#05060a;
    --bg1:#07090f;
    --card0:#0b0f18;
    --card1:#0a0e15;
    --ink:#e9eef8;
    --muted:#9aa3af;

    --accent:#7AE6FF;
    --ring: color-mix(in oklab, var(--accent) 60%, transparent);
    --violet:#B37AFF;
    --amber:#FFB76B;

    --stroke: color-mix(in oklab, var(--accent) 18%, #1a2230);
    --strokeStrong: color-mix(in oklab, var(--accent) 28%, #1a2230);
    --glass: color-mix(in oklab, #0b0f18 86%, transparent);
    --glass2: color-mix(in oklab, #0b0f18 72%, transparent);

    --bg-image:url("./bg_lumina.jpg");
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--ink);
    font:15px/1.55 Inter, ui-sans-serif, system-ui, -apple-system, "SF Pro Text", Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
    background: #000;
    overflow:hidden;
    -webkit-font-smoothing:antialiased;
    text-rendering:optimizeLegibility;
  }

  .bg{
    position:fixed; inset:0; z-index:-5;
    background-image: var(--bg-image);
    background-size:cover;
    background-position:center;
    background-repeat:no-repeat;
    filter:saturate(1.05) brightness(.92);
    transform: translateZ(0);
  }
  .bg::after{
    content:"";
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 720px at 80% -10%, color-mix(in oklab, var(--accent) 18%, #000) 0%, transparent 62%),
      radial-gradient(980px 640px at -10% 90%, color-mix(in oklab, var(--accent) 12%, #000) 0%, transparent 58%),
      linear-gradient(180deg, #04050ad9 0%, #05060ae6 100%);
  }
  .noise{
    position:fixed; inset:0; z-index:-4; pointer-events:none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.32'/%3E%3C/svg%3E");
    mix-blend-mode:overlay;
    opacity:.22;
  }
  .stars{
    position:fixed; inset:0; z-index:-3; pointer-events:none; opacity:.08;
    background-image:
      radial-gradient(1px 1px at 12% 20%, #fff 50%, transparent 51%),
      radial-gradient(1px 1px at 72% 62%, #fff 50%, transparent 51%),
      radial-gradient(1px 1px at 38% 84%, #fff 50%, transparent 51%),
      radial-gradient(1px 1px at 88% 18%, #fff 50%, transparent 51%);
    background-size:28px 28px, 34px 34px, 46px 46px, 54px 54px;
    mix-blend-mode:screen;
  }

  .bar{
    height:68px;
    padding:0 16px;
    display:flex;
    align-items:center;
    gap:12px;
    border-bottom:1px solid color-mix(in oklab, var(--accent) 16%, transparent);
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--accent) 8%, #000) 0%, transparent 100%);
    position:sticky; top:0; z-index:50;
    backdrop-filter: blur(10px);
  }
  .brandMark{
    width:34px;height:34px;border-radius:14px;
    background: conic-gradient(from 210deg, var(--accent), var(--violet), var(--amber), var(--accent));
    box-shadow:
      0 0 0 2px #0a0d14,
      0 0 26px var(--ring) inset,
      0 10px 26px #0008;
    animation: hue 10s linear infinite;
  }
  @keyframes hue{from{filter:hue-rotate(0)}to{filter:hue-rotate(360deg)}}

  .brandText{display:flex; flex-direction:column; gap:2px; min-width:160px;}
  .brandText .top{
    font-family:"Space Grotesk", Inter, system-ui;
    font-weight:800;
    letter-spacing:.18em;
    text-transform:uppercase;
    font-size:12px;
    background: linear-gradient(90deg, var(--accent), var(--violet), var(--amber));
    -webkit-background-clip:text; background-clip:text;
    color:transparent;
    background-size:200% 100%;
    animation: titleFlow 9s linear infinite;
    text-shadow:0 0 18px #7ae6ff22;
  }
  .brandText .sub{
    font-size:12px;
    color: color-mix(in oklab, var(--ink) 62%, var(--accent));
    opacity:.9;
    letter-spacing:.02em;
  }
  @keyframes titleFlow{from{background-position:0% 50%}to{background-position:200% 50%}}

  .right{margin-left:auto; display:flex; align-items:center; gap:10px;}

  .tonePill{
    padding:7px 12px;
    border-radius:999px;
    background: color-mix(in oklab, var(--accent) 14%, #000);
    color: color-mix(in oklab, var(--ink) 80%, var(--accent));
    border:1px solid color-mix(in oklab, var(--accent) 34%, transparent);
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.16em;
    opacity:.92;
    box-shadow: 0 10px 26px #0006;
  }

  .btn{
    --mx:50%;--my:50%;
    position:relative;
    display:inline-flex;align-items:center;justify-content:center;
    padding:0 16px;
    height:40px;
    border-radius:14px;
    border:none;
    cursor:pointer;
    background:linear-gradient(135deg,var(--accent),var(--amber));
    box-shadow:0 14px 30px rgba(122,230,255,.30),0 2px 10px rgba(0,0,0,.55);
    color:#051014;
    font-weight:900;
    letter-spacing:.14em;
    text-transform:uppercase;
    overflow:hidden;
    transform-style:preserve-3d;
    transition:transform .16s, box-shadow .16s, filter .16s;
    user-select:none;
  }
  .btn .label{
    position:relative; z-index:2;
    background: linear-gradient(90deg,#fff,#d8f7ff,#fff);
    background-size:200% 100%;
    -webkit-background-clip:text;background-clip:text;
    color:transparent;
    animation:shineText 3.2s linear infinite;
  }
  @keyframes shineText{from{background-position:0% 50%}to{background-position:200% 50%}}
  .btn::after{
    content:"";
    position:absolute; inset:-1px;
    pointer-events:none;
    background: radial-gradient(160px 160px at var(--mx) var(--my), rgba(255,255,255,.18), rgba(255,255,255,0) 62%);
    opacity:0; transition:opacity .18s;
  }
  .btn:hover{ box-shadow:0 18px 42px rgba(122,230,255,.40),0 6px 18px rgba(0,0,0,.55) }
  .btn:hover::after{opacity:1}
  .btn:active{ transform: scale(.985) }

  .btn.ghost{
    background: linear-gradient(180deg, #0e131b, #0a0e14);
    color: var(--ink);
    border: 1px solid var(--strokeStrong);
    box-shadow: 0 2px 10px rgba(0,0,0,.52), inset 0 0 0 999px #ffffff08;
  }
  .btn.ghost .label{
    background:none; color:var(--ink);
    -webkit-background-clip:initial;background-clip:initial;
    animation:none; opacity:.88;
  }
  .btn.sm{ height:36px; border-radius:12px; letter-spacing:.12em; font-size:12px; padding:0 12px; }

  .wrap{
    height:calc(100% - 68px);
    display:grid;
    grid-template-rows: 1fr auto;
    grid-template-columns: 1fr;
    grid-template-areas:
      "feed"
      "composer";
  }

  .feed{
    grid-area:feed;
    overflow:auto;
    padding:22px 16px 10px;
    scroll-behavior:smooth;
    -webkit-overflow-scrolling:touch;
  }
  .feedInner{max-width:980px; margin:0 auto;}

  .bubble{
    max-width:min(900px,92vw);
    margin:10px 0;
    padding:14px 16px;
    white-space:pre-wrap;
    border-radius:16px;
    position:relative;
    background:
      linear-gradient(180deg, var(--glass) 0%, color-mix(in oklab, #0a0e15 88%, transparent) 100%);
    border:1px solid var(--stroke);
    box-shadow:
      0 1px 0 #0008,
      inset 0 0 0 999px #ffffff03,
      0 14px 34px #000b;
    backdrop-filter: blur(10px);
  }
  .bubble::before{
    content:"";
    position:absolute; inset:-1px;
    border-radius:inherit;
    pointer-events:none;
    background:
      radial-gradient(420px 220px at 12% 12%, color-mix(in oklab, var(--accent) 18%, transparent) 0%, transparent 65%),
      radial-gradient(380px 240px at 92% 20%, color-mix(in oklab, var(--violet) 12%, transparent) 0%, transparent 60%);
    opacity:.35;
    filter: blur(8px);
  }
  .bubble::after{
    content:"";
    position:absolute; inset:-1px;
    border-radius:inherit;
    pointer-events:none;
    background: linear-gradient(120deg, transparent 34%, rgba(255,255,255,.12) 50%, transparent 68%);
    mix-blend-mode:screen;
    opacity:0;
    transition:opacity .25s;
  }
  .bubble:hover::after{ opacity:.55 }

  .acai{ border-color: color-mix(in oklab, var(--accent) 24%, #1a2230); }
  .me{
    margin-left:auto;
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--accent) 18%, var(--glass2)) 0%, color-mix(in oklab, #0a0e15 90%, transparent) 100%);
    border-color: color-mix(in oklab, var(--accent) 34%, #1a2230);
  }

  .typing{ display:inline-flex; align-items:center; gap:8px;
    color: color-mix(in oklab, var(--ink) 74%, var(--accent));
    font-weight:600; letter-spacing:.06em;
  }
  .dots{ display:inline-flex; gap:4px; }
  .dots i{
    width:6px;height:6px;border-radius:50%;
    background: color-mix(in oklab, var(--accent) 90%, #fff);
    opacity:.35;
    animation: blink 1.2s infinite;
  }
  .dots i:nth-child(2){animation-delay:.2s}
  .dots i:nth-child(3){animation-delay:.4s}
  @keyframes blink{0%,100%{opacity:.22;transform:translateY(0)}50%{opacity:1;transform:translateY(-2px)}}

  .composer{
    grid-area: composer;
    padding: 12px 16px 16px;
    border-top:1px solid #0a0d12;
    background: linear-gradient(180deg, rgba(10,15,22,.92), rgba(8,11,17,.96));
    backdrop-filter: blur(10px);
  }
  .composerInner{
    max-width: 980px;
    margin: 0 auto;
    display:flex;
    gap:10px;
    align-items:flex-end;
  }
  .in{
    flex:1;
    background: color-mix(in oklab, #0e131b 92%, transparent);
    border:1px solid #151c26;
    color:var(--ink);
    border-radius:16px;
    padding:12px 14px;
    outline:none;
    transition:border-color .2s, box-shadow .2s;
    resize:none;
    min-height:46px;
    max-height:180px;
    line-height:1.45;
    box-shadow: inset 0 0 0 999px #ffffff05;
  }
  .in:focus{
    border-color: color-mix(in oklab, var(--accent) 38%, #222);
    box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 18%, transparent);
  }

  .edgeBtns{
    position:fixed;
    right:12px;
    top: calc(68px + 14px);
    z-index: 60;
    display:flex;
    flex-direction:column;
    gap:10px;
    pointer-events:auto;
  }
  .edgeBtn{
    width:46px;height:46px;
    border-radius:16px;
    border:1px solid var(--strokeStrong);
    background: linear-gradient(180deg, #0e131b, #0a0e14);
    box-shadow: 0 12px 28px rgba(0,0,0,.58), inset 0 0 0 999px #ffffff08;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    color: color-mix(in oklab, var(--ink) 78%, var(--accent));
    transition: transform .16s ease, filter .16s ease, box-shadow .16s ease;
  }
  .edgeBtn:hover{ filter:brightness(1.08); box-shadow: 0 16px 36px rgba(0,0,0,.64), 0 0 26px var(--ring); }
  .edgeBtn:active{ transform: scale(.985); }
  .edgeBtn svg{ width:22px;height:22px; opacity:.92; }

  .overlay{
    position:fixed; inset:0;
    background: rgba(0,0,0,.46);
    backdrop-filter: blur(10px);
    z-index: 70;
    opacity:0;
    pointer-events:none;
    transition: opacity .18s ease;
  }
  .overlay.show{ opacity:1; pointer-events:auto; }

  .drawer{
    position:fixed;
    top:68px;
    right:0;
    height: calc(100% - 68px);
    width: min(460px, 92vw);
    z-index: 80;
    transform: translateX(104%);
    transition: transform .22s cubic-bezier(.2,.9,.2,1);
    padding: 14px 12px;
    display:flex;
    flex-direction:column;
    gap:12px;
    overflow:hidden;
  }
  .drawer.open{ transform: translateX(0); }

  .drawerHeader{
    flex: 0 0 auto;
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding: 10px 10px;
    border-radius: 16px;
    background: linear-gradient(180deg, var(--glass) 0%, color-mix(in oklab, #0a0e15 88%, transparent) 100%);
    border: 1px solid var(--stroke);
    box-shadow: 0 12px 30px #000a, inset 0 0 0 999px #ffffff03;
    backdrop-filter: blur(12px);
  }
  .drawerTitle{
    display:flex; align-items:center; gap:10px;
    font-family: "Space Grotesk", Inter, system-ui;
    font-weight: 700;
    letter-spacing:.14em;
    text-transform:uppercase;
    font-size: 12px;
    color: color-mix(in oklab, var(--ink) 82%, var(--accent));
  }

  .luxDot{
    width:10px;height:10px;border-radius:50%;
    background: var(--accent);
    box-shadow: 0 0 18px var(--ring), 0 0 40px color-mix(in oklab, var(--accent) 25%, transparent);
    animation: breathe 2.4s ease-in-out infinite;
  }
  @keyframes breathe{
    0%,100%{ transform: scale(.92); opacity:.72; }
    50%{ transform: scale(1.14); opacity:1; }
  }

  .drawerClose{
    border:none;
    background: linear-gradient(180deg,#0e131b,#0a0e14);
    color: var(--ink);
    border:1px solid var(--strokeStrong);
    border-radius: 12px;
    height:34px;
    padding:0 12px;
    cursor:pointer;
    box-shadow: 0 10px 22px rgba(0,0,0,.42), inset 0 0 0 999px #ffffff06;
  }

  .drawerBody{
    flex: 1 1 auto;
    min-height: 0;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    padding-right: 2px;
  }

  .panel{
    position:relative;
    padding:14px 14px 12px;
    border-radius: 18px;
    background: linear-gradient(180deg, var(--glass) 0%, color-mix(in oklab, #0a0e15 88%, transparent) 100%);
    border: 1px solid var(--stroke);
    box-shadow: 0 1px 0 #0008, inset 0 0 0 999px #ffffff03, 0 14px 36px #000b;
    overflow:hidden;
    backdrop-filter: blur(12px);
  }
  .panel::before{
    content:"";
    position:absolute; inset:-2px;
    border-radius: inherit;
    background:
      radial-gradient(420px 260px at 30% 20%, color-mix(in oklab, var(--accent) 22%, transparent) 0%, transparent 60%),
      radial-gradient(320px 240px at 80% 30%, color-mix(in oklab, var(--violet) 14%, transparent) 0%, transparent 62%);
    filter: blur(12px);
    opacity:.8;
    pointer-events:none;
  }

  .panelHead{
    position:relative;
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:10px;
    gap:10px;
  }
  .panelTitle{
    font-family:"Space Grotesk", Inter, system-ui;
    font-weight: 700;
    letter-spacing: .14em;
    text-transform: uppercase;
    font-size: 12px;
    color: color-mix(in oklab, var(--ink) 82%, var(--accent));
    opacity:.95;
    display:flex; align-items:center; gap:10px;
  }
  .pill{
    position:relative;
    font-size: 11px;
    padding:6px 10px;
    border-radius: 999px;
    border: 1px solid color-mix(in oklab, var(--accent) 30%, transparent);
    background: color-mix(in oklab, var(--accent) 12%, #000);
    color: color-mix(in oklab, var(--ink) 78%, var(--accent));
    opacity:.95;
    white-space:nowrap;
    box-shadow: 0 8px 20px rgba(0,0,0,.35);
  }

  .miniLegend{
    position:relative;
    display:flex; flex-wrap:wrap; gap:6px;
    margin-top:10px;
  }
  .tag{
    font-size:11px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid color-mix(in oklab, var(--accent) 22%, #1a2230);
    background: linear-gradient(180deg, #0e131b, #0a0e14);
    color: color-mix(in oklab, var(--ink) 76%, var(--accent));
    opacity:.92;
  }

  .chartBox{ height: min(46vh, 440px); width:100%; position:relative; }
  .chartBox.radarBox{ height: min(44vh, 390px); }
  canvas{ display:block; width:100% !important; height:100% !important; }

  @media (prefers-reduced-motion: reduce){
    *{ animation-duration: .001ms !important; animation-iteration-count: 1 !important; transition-duration: .001ms !important; scroll-behavior:auto !important; }
  }
  @media (max-width: 520px){
    body{ overflow:hidden; }
    .edgeBtns{ right: 10px; top: calc(68px + 10px); }
    .drawer{ width: 94vw; }
    .chartBox{ height: min(52vh, 440px); }
    .chartBox.radarBox{ height: min(48vh, 390px); }
  }
</style>
</head>

<body>
  <div class="bg" aria-hidden="true"></div>
  <div class="noise" aria-hidden="true"></div>
  <div class="stars" aria-hidden="true"></div>

  <header class="bar">
    <div class="brandMark" aria-hidden="true"></div>

    <div class="brandText">
      <div class="top">AFFECTIVE CONTEXTUAL AI</div>
      <div class="sub">LUMINA Console ¬∑ Affective Cybernetics</div>
    </div>

    <div class="right">
      <div class="tonePill" id="tone">NEUTRAL</div>
      <button class="btn ghost sm" id="voice" type="button"><span class="label">VOICE:ON</span></button>
      <button class="btn ghost sm" id="logout" type="button"><span class="label">LOGOUT</span></button>
    </div>
  </header>

  <section class="wrap">
    <div class="feed" id="feed">
      <div class="feedInner" id="feedInner"></div>
    </div>

    <form class="composer" id="form" novalidate>
      <div class="composerInner">
        <textarea id="msg" class="in" placeholder="Type a message‚Ä¶" rows="1"></textarea>
        <button class="btn" id="send" type="submit"><span class="label">SEND</span></button>
        <button class="btn ghost" id="clean" type="button"><span class="label">CLEAN</span></button>
      </div>
    </form>
  </section>

  <div class="edgeBtns" aria-label="Widgets">
    <button class="edgeBtn" id="openRadar" type="button" title="Emotion Radar">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M12 21a9 9 0 1 0-9-9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M12 12l6-3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M3 12h2M12 3v2M19 12h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity=".8"/>
        <circle cx="12" cy="12" r="2" stroke="currentColor" stroke-width="2"/>
      </svg>
    </button>

    <button class="edgeBtn" id="openEMC" type="button" title="E ¬∑ M ¬∑ C Timeline">
      <svg viewBox="0 0 24 24" fill="none">
        <path d="M4 19V5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M4 19H20" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 15l4-5 4 3 5-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="10" cy="10" r="1.5" fill="currentColor"/>
        <circle cx="14" cy="13" r="1.5" fill="currentColor" opacity=".9"/>
        <circle cx="19" cy="6" r="1.5" fill="currentColor" opacity=".85"/>
      </svg>
    </button>
  </div>

  <div class="overlay" id="overlay" aria-hidden="true"></div>

  <aside class="drawer" id="radarDrawer" aria-label="Emotion Radar Widget">
    <div class="drawerHeader">
      <div class="drawerTitle"><span class="luxDot" aria-hidden="true"></span> Emotion Radar</div>
      <button class="drawerClose" type="button" data-close="radar">Close</button>
    </div>
    <div class="drawerBody">
      <section class="panel">
        <div class="panelHead">
          <div class="panelTitle"><span class="luxDot" aria-hidden="true"></span> Emotion Radar</div>
          <div class="pill" id="radarMeta">‚Äî</div>
        </div>
        <div class="chartBox radarBox">
          <canvas id="emotionRadar"></canvas>
        </div>
        <div class="miniLegend" id="emotionTags"></div>
      </section>
    </div>
  </aside>

  <aside class="drawer" id="emcDrawer" aria-label="E M C Widget">
    <div class="drawerHeader">
      <div class="drawerTitle"><span class="luxDot" aria-hidden="true"></span> E ¬∑ M ¬∑ C Timeline</div>
      <button class="drawerClose" type="button" data-close="emc">Close</button>
    </div>
    <div class="drawerBody">
      <section class="panel">
        <div class="panelHead">
          <div class="panelTitle"><span class="luxDot" aria-hidden="true"></span> E ¬∑ M ¬∑ C Timeline</div>
          <div class="pill" id="emcMeta">‚Äî</div>
        </div>
        <div class="chartBox">
          <canvas id="emcChart"></canvas>
        </div>
      </section>
    </div>
  </aside>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
  /* =========================
     ‚úÖ LOGIC: unchanged core
     ========================= */

  // 1) token boot
  (function bootToken(){
    const qs = new URLSearchParams(location.search);
    const t = qs.get('token');
    if (t && t.length > 10) {
      try { localStorage.setItem('acai_jwt', t); } catch {}
      history.replaceState({}, '', location.pathname + location.hash);
    }
  })();

  // 2) backend
  const API = (localStorage.getItem('ACAI_API') || 'https://acai-backend.onrender.com').replace(/\/$/,'');

  function authHeaders(){
    let tok = null;
    try { tok = localStorage.getItem('acai_jwt'); } catch {}
    return tok ? { Authorization: 'Bearer ' + tok } : {};
  }

  async function apiPost(path, data){
    const r = await fetch(API+path, {
      method:'POST',
      credentials:'include',
      headers:{'Content-Type':'application/json', ...authHeaders()},
      body: JSON.stringify(data||{})
    });
    if (r.status === 401) throw new Error('AUTH');
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function apiGet(path){
    const r = await fetch(API+path, { method:'GET', credentials:'include', headers: authHeaders(), cache:'no-store' });
    if (r.status === 401) throw new Error('AUTH');
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  async function apiDelete(path){
    const r = await fetch(API+path, { method:'DELETE', credentials:'include', headers: authHeaders() });
    if (r.status === 401) throw new Error('AUTH');
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function forceReauth(){ location.href = API + '/auth/refresh'; }

  /* =========================
     ‚úÖ iOS/Safari AUDIO UNLOCK (FIX)
     ========================= */
  let audioCtx = null;
  let audioUnlocked = false;

  async function unlockAudio(){
    if (audioUnlocked) return true;
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return false;

    try{
      audioCtx = audioCtx || new Ctx();
      await audioCtx.resume();

      // prime: tiny silent buffer (helps some iOS versions)
      const buf = audioCtx.createBuffer(1, 1, 22050);
      const src = audioCtx.createBufferSource();
      src.buffer = buf;
      src.connect(audioCtx.destination);
      try { src.start(0); } catch {}
      audioUnlocked = (audioCtx.state === 'running');
      return audioUnlocked;
    }catch(e){
      return false;
    }
  }

  /* =========================
     DOM
     ========================= */
  const feed = document.getElementById('feed');
  const feedInner = document.getElementById('feedInner');
  const tone = document.getElementById('tone');
  const form = document.getElementById('form');
  const msg  = document.getElementById('msg');
  const cleanBtn = document.getElementById('clean');
  const voiceBtn = document.getElementById('voice');

  let VOICE_ON = (() => {
    try { return JSON.parse(localStorage.getItem('lumina_voice_on') || 'true'); }
    catch { return true; }
  })();

  function renderVoiceBtn(){
    if (!voiceBtn) return;
    const lab = voiceBtn.querySelector('.label');
    if (lab) lab.textContent = VOICE_ON ? 'VOICE:ON' : 'VOICE:OFF';
    voiceBtn.style.opacity = VOICE_ON ? '1' : '.78';
  }
  renderVoiceBtn();

  // ‚úÖ voice toggle + iOS unlock (must be user gesture)
  voiceBtn?.addEventListener('click', async () => {
    VOICE_ON = !VOICE_ON;
    try { localStorage.setItem('lumina_voice_on', JSON.stringify(VOICE_ON)); } catch {}
    renderVoiceBtn();

    if (VOICE_ON) {
      await unlockAudio(); // üëà –∫–ª—é—á –¥–ª—è iPhone
    } else {
      try { if (currentAudio) { currentAudio.pause(); currentAudio = null; } } catch {}
    }
  });

  let currentAudio = null;

  async function fetchTTSObjectUrl(text){
    const t = (text || '').trim();
    if (!t) return null;

    const url = API + '/api/tts?text=' + encodeURIComponent(t.slice(0, 1400));

    const r = await fetch(url, {
      method: 'GET',
      credentials: 'include',
      headers: { ...authHeaders() },
      cache: 'no-store'
    });

    if (r.status === 401) throw new Error('AUTH');
    if (!r.ok) throw new Error('TTS_FAIL');

    const blob = await r.blob();
    return URL.createObjectURL(blob); // ‚úÖ audio/mp3 as blob url
  }

  async function speak(text){
    if (!VOICE_ON) return;
    const t = (text || '').trim();
    if (!t) return;

    // iOS safety: try to keep audio unlocked
    await unlockAudio();

    // stop previous
    try { if (currentAudio) { currentAudio.pause(); currentAudio = null; } } catch {}

    const url = API + '/api/tts?text=' + encodeURIComponent(t.slice(0, 1400));

    const r = await fetch(url, {
      method: 'GET',
      credentials: 'include',
      headers: { ...authHeaders() },
      cache: 'no-store'
    });

    if (r.status === 401) throw new Error('AUTH');
    if (!r.ok) throw new Error('TTS_FAIL');

    const blob = await r.blob();
    const obj = URL.createObjectURL(blob);

    const a = new Audio(obj);
    a.preload = 'auto';
    a.playsInline = true;          // iOS
    a.crossOrigin = 'anonymous';   // safe
    a.volume = 1.0;

    currentAudio = a;

    try {
      await a.play();
    } catch (e) {
      // –µ—Å–ª–∏ Safari —Å–Ω–æ–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª ‚Äî –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–ª–æ—á–∏—Ç—å –µ—â—ë —Ä–∞–∑ (–Ω–∞ –≤—Å—è–∫–∏–π)
      await unlockAudio();
      try { await a.play(); } catch(_) {}
    }

    a.addEventListener('ended', () => {
      try { URL.revokeObjectURL(obj); } catch {}
      if (currentAudio === a) currentAudio = null;
    });
  }

  /* Drawers */
  const overlay = document.getElementById('overlay');
  const radarDrawer = document.getElementById('radarDrawer');
  const emcDrawer = document.getElementById('emcDrawer');
  const openRadarBtn = document.getElementById('openRadar');
  const openEMCBtn = document.getElementById('openEMC');

  function closeAllDrawers(){
    radarDrawer.classList.remove('open');
    emcDrawer.classList.remove('open');
    overlay.classList.remove('show');
  }

  function afterOpenResize(which){
    setTimeout(() => {
      if (which === 'radar' && radarChart){ radarChart.resize(); radarChart.update('none'); }
      if (which === 'emc' && emcChart){ emcChart.resize(); emcChart.update('none'); }
    }, 260);
  }

  function openDrawer(which){
    closeAllDrawers();
    if (which === 'radar') radarDrawer.classList.add('open');
    if (which === 'emc') emcDrawer.classList.add('open');
    overlay.classList.add('show');

    if (which === 'radar'){ ensureRadar(); applyLuxChartColors(); }
    if (which === 'emc'){ ensureEMC(); applyLuxChartColors(); }
    afterOpenResize(which);
  }

  openRadarBtn.addEventListener('click', ()=> openDrawer('radar'));
  openEMCBtn.addEventListener('click', ()=> openDrawer('emc'));
  overlay.addEventListener('click', closeAllDrawers);
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeAllDrawers(); });
  document.querySelectorAll('[data-close]').forEach(btn=> btn.addEventListener('click', closeAllDrawers));

  /* LUX helpers */
  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function alphaColor(rgbLike, a){ return `color-mix(in oklab, ${rgbLike} ${Math.round(a*100)}%, transparent)`; }

  /* Charts */
  const radarMeta = document.getElementById('radarMeta');
  const emcMeta = document.getElementById('emcMeta');
  const tagsBox = document.getElementById('emotionTags');

  let radarChart = null;
  let emcChart = null;

  function ensureRadar(){
    if (radarChart) return;
    const ctx = document.getElementById('emotionRadar')?.getContext('2d');
    if (!ctx) return;

    radarChart = new Chart(ctx, {
      type: "radar",
      data: {
        labels: ["‚Äî","‚Äî","‚Äî","‚Äî","‚Äî"],
        datasets: [{
          label: "Top emotions",
          data: [0,0,0,0,0],
          fill: true,
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 6,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 360 },
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: "rgba(8,10,14,.92)",
            borderColor: "rgba(255,255,255,.10)",
            borderWidth: 1,
            titleColor: "#fff",
            bodyColor: "#fff",
            callbacks: { label: (c) => `${c.label}: ${(Number(c.raw||0)*100).toFixed(0)}%` }
          }
        },
        scales: {
          r: {
            min: 0, max: 1,
            grid: { color: "rgba(255,255,255,.06)" },
            angleLines: { color: "rgba(255,255,255,.08)" },
            pointLabels: { color: "rgba(255,255,255,.78)", font: { size: 12, weight: "600" } },
            ticks: { display: false }
          }
        }
      }
    });
  }

  const MAX_POINTS = 120;
  const POLL_MS = 1500;

  const KEY_STATE = "acai_last_state";
  const KEY_EMC   = "acai_emc_series";
  const KEY_T0    = "acai_emc_t0";

  let t0 = Number(sessionStorage.getItem(KEY_T0) || 0) || performance.now();
  let emcSeries = (() => {
    try { return JSON.parse(sessionStorage.getItem(KEY_EMC) || "null") || {t:[],E:[],M:[],C:[]}; }
    catch { return {t:[],E:[],M:[],C:[]}; }
  })();

  function persistEMC(){
    try {
      sessionStorage.setItem(KEY_EMC, JSON.stringify(emcSeries));
      sessionStorage.setItem(KEY_T0, String(t0));
    } catch {}
  }

  function ensureEMC(){
    if (emcChart) return;
    const ctx = document.getElementById('emcChart')?.getContext('2d');
    if (!ctx) return;

    emcChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: emcSeries.t || [],
        datasets: [
          { label:"E", data: emcSeries.E || [], borderWidth: 2, pointRadius: 0, tension: 0.28 },
          { label:"M", data: emcSeries.M || [], borderWidth: 2, pointRadius: 0, tension: 0.28 },
          { label:"C", data: emcSeries.C || [], borderWidth: 2, pointRadius: 0, tension: 0.28 },
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 220 },
        plugins: {
          legend: { labels: { color: "rgba(255,255,255,.78)", boxWidth: 10, usePointStyle: true, pointStyle:"circle" } },
          tooltip: {
            backgroundColor: "rgba(8,10,14,.92)",
            borderColor: "rgba(255,255,255,.10)",
            borderWidth: 1,
            titleColor: "#fff",
            bodyColor: "#fff",
          }
        },
        scales: {
          x: { grid: { color: "rgba(255,255,255,.05)" }, ticks: { color: "rgba(255,255,255,.55)", maxTicksLimit: 6 } },
          y: { grid: { color: "rgba(255,255,255,.05)" }, ticks: { color: "rgba(255,255,255,.55)" }, suggestedMin: -1.2, suggestedMax: 1.2 }
        }
      }
    });
  }

  function applyLuxChartColors(){
    const accent = cssVar('--accent') || '#7AE6FF';

    if (radarChart){
      radarChart.data.datasets[0].borderColor = accent;
      radarChart.data.datasets[0].backgroundColor = alphaColor(accent, 0.14);
      radarChart.data.datasets[0].pointBackgroundColor = accent;
      radarChart.data.datasets[0].pointBorderColor = alphaColor(accent, 0.35);
      radarChart.update('none');
    }

    if (emcChart){
      const violet = cssVar('--violet') || '#B37AFF';
      const amber  = cssVar('--amber')  || '#FFB76B';
      emcChart.data.datasets[0].borderColor = accent;
      emcChart.data.datasets[1].borderColor = violet;
      emcChart.data.datasets[2].borderColor = amber;
      emcChart.update('none');
    }
  }

  function renderEmotionTags(top5){
    if (!tagsBox) return;
    tagsBox.innerHTML = "";
    (top5||[]).slice(0,5).forEach(([name, prob])=>{
      const el = document.createElement('span');
      el.className = 'tag';
      const p = clamp(Number(prob||0),0,1);
      el.textContent = `${name} ${(p*100).toFixed(0)}%`;
      tagsBox.appendChild(el);
    });
  }

  function updateRadarFromState(s){
    ensureRadar();
    if (!radarChart) return;

    const top5 = Array.isArray(s?.top5) ? s.top5 : [];
    const labels = top5.map(x => x?.[0] ?? "‚Äî");
    const values = top5.map(x => clamp(Number(x?.[1] ?? 0), 0, 1));

    while (labels.length < 5) labels.push("‚Äî");
    while (values.length < 5) values.push(0);

    radarChart.data.labels = labels.slice(0,5);
    radarChart.data.datasets[0].data = values.slice(0,5);

    renderEmotionTags(top5);

    const v = Number(s?.valence ?? 0);
    const x = Number(s?.impulse_x_ema ?? 0);
    if (radarMeta) radarMeta.textContent = `val=${v.toFixed(2)} ¬∑ x=${x.toFixed(2)}`;

    applyLuxChartColors();
    radarChart.update();
  }

  function pushEMCPoint(s){
    ensureEMC();
    if (!emcChart) return;

    const now = performance.now();
    const t = (now - t0) / 1000.0;
    const label = t < 60 ? `${t.toFixed(0)}s` : `${(t/60).toFixed(1)}m`;

    const E = Number(s?.E ?? 0);
    const M = Number(s?.M ?? 0);
    const C = Number(s?.C ?? 0);

    emcSeries.t.push(label);
    emcSeries.E.push(E);
    emcSeries.M.push(M);
    emcSeries.C.push(C);

    if (emcSeries.t.length > MAX_POINTS){
      emcSeries.t.shift(); emcSeries.E.shift(); emcSeries.M.shift(); emcSeries.C.shift();
    }

    emcChart.data.labels = emcSeries.t;
    emcChart.data.datasets[0].data = emcSeries.E;
    emcChart.data.datasets[1].data = emcSeries.M;
    emcChart.data.datasets[2].data = emcSeries.C;

    if (emcMeta) emcMeta.textContent = `E=${E.toFixed(2)} ¬∑ M=${M.toFixed(2)} ¬∑ C=${C.toFixed(2)}`;

    applyLuxChartColors();
    emcChart.update();

    persistEMC();
  }

  /* Chat local mirror */
  let messages = (() => {
    try { return JSON.parse(localStorage.getItem('lumina_chat') || '[]'); } catch { return []; }
  })();

  if (messages.length === 0) {
    messages.push({role:'assistant', text:'ACAI: Greetings, conscious being. Synchronizing with your emotional field‚Ä¶'});
  }

  function saveAndRender(){
    localStorage.setItem('lumina_chat', JSON.stringify(messages));
    renderFeed();
  }

  function renderFeed(){
    feedInner.innerHTML = '';

    for (const m of messages){
      const el = document.createElement('div');
      el.className = 'bubble ' + (m.role === 'user' ? 'me' : 'acai');

      // ‚úÖ Voice bubble
      if (m.audioUrl) {
        const title = document.createElement('div');
        title.style.fontWeight = '700';
        title.style.opacity = '0.9';
        title.style.marginBottom = '8px';
        title.textContent = (m.role === 'user' ? 'You (voice):' : 'ACAI (voice):');

        const audio = document.createElement('audio');
        audio.controls = true;
        audio.preload = 'metadata';
        audio.playsInline = true;
        audio.src = m.audioUrl;

        // optional: show text under audio (if you want)
        if (m.text) {
          const txt = document.createElement('div');
          txt.style.marginTop = '10px';
          txt.style.opacity = '0.85';
          txt.textContent = m.text;
          el.appendChild(title);
          el.appendChild(audio);
          el.appendChild(txt);
        } else {
          el.appendChild(title);
          el.appendChild(audio);
        }

        feedInner.appendChild(el);
        continue;
      }

      // ‚úÖ Text bubble
      el.textContent = (m.role === 'user' ? 'You: ' : '') + (m.text || '');
      feedInner.appendChild(el);
    }

    feed.scrollTop = feed.scrollHeight;
  }

  function showTyping(){
    const el = document.createElement('div');
    el.className = 'bubble acai';
    el.innerHTML = `<span class="typing">‚ú®<span class="dots"><i></i><i></i><i></i></span></span>`;
    el.dataset.typing='1';
    feedInner.appendChild(el);
    feed.scrollTop = feed.scrollHeight;
    return el;
  }

  function hideTyping(el){ if (el && el.dataset.typing==='1') el.remove(); }

  msg.value = localStorage.getItem('lumina_draft') || '';
  msg.addEventListener('input', ()=> localStorage.setItem('lumina_draft', msg.value));

  msg.addEventListener('input', ()=>{
    msg.style.height = 'auto';
    msg.style.height = Math.min(msg.scrollHeight, 180) + 'px';
  });

  renderFeed();

  /* Theme */
  const map=(v,inMin,inMax,outMin,outMax)=> outMin + (Math.max(inMin,Math.min(inMax,v))-inMin)*(outMax-outMin)/(inMax-inMin);

  function themeFromState(s){
    const v = Number(s?.valence ?? 0);
    const x = Number(s?.impulse_x_ema ?? 0);
    const hue = (v >= 0) ? map(v, 0, 1, 210, 150) : map(v, -1, 0, 10, 210);
    const sat = map(Math.abs(x), 0, 0.5, 55, 92);
    const lig = 54;
    const accent = `oklch(${lig}% ${sat/100} ${hue})`;

    let mode='NEUTRAL';
    if (v > 0.28) mode='GROUND';
    else if (v < -0.22) mode='STABILIZE';
    else if (v < -0.08) mode='UPLIFT';

    document.documentElement.style.setProperty('--accent', accent);
    document.documentElement.style.setProperty('--ring', 'color-mix(in oklab, var(--accent) 60%, transparent)');
    tone.textContent = mode;

    applyLuxChartColors();
  }

  (function warmStart(){
    try{
      const st = JSON.parse(sessionStorage.getItem(KEY_STATE) || "null");
      if (st) {
        themeFromState(st);
        updateRadarFromState(st);
        if (emcMeta){
          const E = Number(st?.E ?? 0), M = Number(st?.M ?? 0), C = Number(st?.C ?? 0);
          emcMeta.textContent = `E=${E.toFixed(2)} ¬∑ M=${M.toFixed(2)} ¬∑ C=${C.toFixed(2)}`;
        }
      }
    } catch {}
  })();

  /* =========================
     State poll + backend session
     ========================= */
  let currentCid = null;

  // ‚úÖ FIX: correctly create conversation via POST /api/conversations
  async function ensureConversation(){
    if (currentCid) return currentCid;

    try{
      const created = await apiPost('/api/conversations', {}); // {ok:true, id: "..."}
      currentCid = created?.id || null;
      if (!currentCid) throw new Error('NO_CID');
      return currentCid;
    } catch (e) {
      if (e.message === 'AUTH') {
        const loginUrl = API + '/login?from=' + encodeURIComponent(location.href);
        let w = null;
        try { w = window.open(loginUrl, '_blank', 'noopener'); } catch(_) {}
        setTimeout(() => { if (!w || w.closed) location.href = loginUrl; }, 300);
        alert('Please login via Telegram, then return here.');
      } else {
        console.error(e);
        alert('Cannot create conversation.');
      }
      throw e;
    }
  }

  async function refreshState(){
    try{
      if (!currentCid) return;
      const r = await fetch(API + `/state/${currentCid}`, {
        cache:'no-store',
        credentials:'include',
        headers: authHeaders()
      });
      if(!r.ok) return;

      const j = await r.json();
      const st = j?.last || {};

      try { sessionStorage.setItem(KEY_STATE, JSON.stringify(st)); } catch {}

      themeFromState(st);
      updateRadarFromState(st);
      pushEMCPoint(st);
    }catch{}
  }

  /* Send */
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();

    // ‚úÖ iPhone FIX: unlock audio inside user gesture (SEND click)
    if (VOICE_ON) { try { await unlockAudio(); } catch {} }

    const text = msg.value.trim();
    if(!text) return;

    messages.push({role:'user', text});
    saveAndRender();

    const typingEl = showTyping();

    try{
      const cid = await ensureConversation();
      const j = await apiPost(`/api/chat/${cid}`, { message: text });
      hideTyping(typingEl);

      const replyText = j?.reply || '(no reply)';

      // ‚úÖ –µ—Å–ª–∏ force_text=true –ò–õ–ò voice –≤—ã–∫–ª—é—á–µ–Ω ‚Üí –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
      if (j?.force_text || !VOICE_ON) {
        messages.push({ role:'assistant', text: replyText });
        saveAndRender();
      } else {
        // ‚úÖ VOICE_ON ‚Üí –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try {
          const audioUrl = await fetchTTSObjectUrl(replyText);

          if (audioUrl) {
            messages.push({
              role: 'assistant',
              audioUrl,      // üëà –∫–ª—é—á–µ–≤–æ–µ
              text: replyText // –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –ø–æ–¥–ø–∏—Å—å
            });
            saveAndRender();
          } else {
            messages.push({ role:'assistant', text: replyText });
            saveAndRender();
          }
        } catch (e) {
          if (e?.message === 'AUTH') forceReauth();
          messages.push({ role:'assistant', text: replyText });
          saveAndRender();
        }
      }

      msg.value = '';
      localStorage.removeItem('lumina_draft');
      msg.style.height = '46px';

      refreshState();
    }catch(err){
      hideTyping(typingEl);
      if (err.message === 'AUTH') {
        messages.push({role:'assistant', text:'Reauth‚Ä¶'});
        saveAndRender();
        forceReauth();
      } else {
        messages.push({role:'assistant', text:'Error: cannot reach backend.'});
        saveAndRender();
      }
    }
  });

  /* CLEAN */
  cleanBtn.addEventListener('click', async () => {
    if (!confirm("Delete local chat history? (You stay logged in)")) return;

    try { await apiDelete('/api/memory'); } catch(e){
      if (e.message==='AUTH'){ return forceReauth(); }
    }

    try {
      localStorage.removeItem('lumina_chat');
      localStorage.removeItem('lumina_draft');
      sessionStorage.removeItem(KEY_EMC);
      sessionStorage.removeItem(KEY_STATE);
      sessionStorage.removeItem(KEY_T0);
    } catch {}

    messages = [{ role:'assistant', text:'ACAI: Greetings, conscious being. Synchronizing with your emotional field‚Ä¶' }];
    currentCid = null;

    emcSeries = { t:[], E:[], M:[], C:[] };
    t0 = performance.now();
    persistEMC();

    if (emcChart){
      emcChart.data.labels = [];
      emcChart.data.datasets.forEach(d => d.data = []);
      emcChart.update();
    }
    if (radarChart){
      radarChart.data.labels = ["‚Äî","‚Äî","‚Äî","‚Äî","‚Äî"];
      radarChart.data.datasets[0].data = [0,0,0,0,0];
      radarChart.update();
    }
    if (tagsBox) tagsBox.innerHTML = "";
    if (radarMeta) radarMeta.textContent = "‚Äî";
    if (emcMeta) emcMeta.textContent = "‚Äî";

    saveAndRender();
  });

  /* Init */
  (async () => {
    ensureRadar();
    ensureEMC();
    applyLuxChartColors();

    try { await ensureConversation(); } catch(_) {}
    refreshState();
    setInterval(refreshState, POLL_MS);
  })();
  </script>

  <!-- Music (unchanged idea) -->
  <audio id="luminaMusic" loop>
    <source src="./lumina_theme.mp3" type="audio/mpeg">
  </audio>
  <script>
    const audio = document.getElementById('luminaMusic');
    document.addEventListener('click', () => {
      try {
        audio.volume = 0;
        audio.play().catch(()=>{});
        let v = 0;
        const fade = setInterval(() => {
          if (v < 0.35) { v += 0.01; audio.volume = v; } else { clearInterval(fade); }
        }, 120);
      } catch(e) {}
    }, { once:true });
  </script>

  <!-- Logout (same logic) -->
  <script>
    document.getElementById('logout')?.addEventListener('click', async (e)=>{
      e.preventDefault(); e.stopPropagation();
      if (!confirm('–í—ã –¥–µ–∏—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–∏—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) return;

      try { await fetch(API + '/logout', { method:'POST', credentials:'include', headers: authHeaders() }); } catch(e){}

      try {
        localStorage.removeItem('acai_jwt');
        localStorage.removeItem('lumina_chat');
        localStorage.removeItem('lumina_draft');
        sessionStorage.clear?.();
      } catch(e){}

      try {
        const u = new URL(location.href);
        u.searchParams.delete('token');
        history.replaceState({}, '', u.pathname + u.hash);
      } catch(e){}

      location.href = 'https://acai-frontend.onrender.com';
    });
  </script>
</body>
</html>
